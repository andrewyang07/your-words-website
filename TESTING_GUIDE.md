# 测试指南

## 🎯 本次更新测试要点

### 1. 用户统计修复测试

**问题**：用户数一直显示为 0

**修复**：统一 Redis key 命名（`total_users` 而非 `stats:total_users`）

**测试步骤**：
1. 访问主页（首次访问）
2. 查看引导卡片中的"已有 XXX 位弟兄姊妹"
3. **预期结果**：应该显示真实的用户数（不再是 0）

**注意**：
- 本地开发时会显示模拟数据（10位用户）
- Vercel 生产环境会显示真实数据

---

### 2. Top 7 经文内容显示

**新功能**：侧边栏 Top 7 现在显示经文内容

**测试步骤**：
1. 打开侧边栏菜单（点击右上角"菜單"按钮）
2. 滚动到底部查看"🏆 最多收藏經文"
3. **预期结果**：
   - 每个经文卡片显示：排名、书卷章节、经文内容（小字、最多2行）、收藏数
   - 经文内容应该是繁体中文
   - 文字应该比较小（10px），最多显示 2 行

**示例显示**：
```
🥇 1
約翰福音 3:16
神愛世人，甚至將他的獨生子賜給他們，叫一切信他的，
不至滅亡，反得永生。
⭐ 10 人收藏
```

---

### 3. 查看章节按钮跳转

**问题**：侧边栏 Top 7 的"查看章节"按钮不跳转

**修复**：
- 添加 URL 参数处理逻辑
- 添加调试日志
- 优化书卷匹配

**测试步骤**：
1. 打开侧边栏菜单
2. 在 Top 7 列表中点击任意经文的"→"按钮
3. **预期结果**：
   - 侧边栏关闭
   - 页面跳转到对应的圣经章节
   - 显示该章的所有经文
   - 自动切换到阅读模式

**调试**：
- 打开浏览器控制台（F12）
- 点击"查看章节"按钮
- 应该看到以下日志：
  ```
  查看章节 - 书卷: 約翰福音 章节: 3
  跳转URL: /?book=%E7%B4%84%E7%BF%B0%E7%A6%8F%E9%9F%B3&chapter=3
  URL参数 - book: 約翰福音 chapter: 3
  找到的书卷: {name: "約翰福音", ...}
  设置书卷和章节: 約翰福音 3
  ```

---

### 4. 总排行榜页面

**功能**：查看所有被收藏的经文排行

**测试步骤**：
1. 打开侧边栏
2. 点击底部的"📊 查看總排行榜"按钮
3. **预期结果**：
   - 跳转到 `/rankings` 页面
   - 显示所有被收藏的经文（按收藏数降序）
   - 前3名显示奖牌图标（🥇🥈🥉）
   - 每个经文有"查看章節"按钮

**降级测试**：
- 如果 Redis 不可用或数据为空，应显示"暫無排行榜數據"
- 不应该导致页面崩溃或无限加载

---

### 5. Redis 降级测试（本地开发）

**目标**：确保所有页面在 Redis 不可用时都能正常渲染

**测试步骤**：
1. 确保本地环境**没有**配置 Redis 环境变量
2. 启动开发服务器：`npm run dev`
3. 访问以下页面，确保都能正常显示：

**主页（`/`）**：
- ✅ 页面正常加载
- ✅ 全局统计显示模拟数据（10位用户、50次收藏、200次点击）
- ✅ 卡片正常显示
- ✅ 点击卡片和收藏功能正常（不报错）

**侧边栏 Top 7**：
- ✅ 显示 Mock 数据（7个经文，带内容）
- ✅ 收藏数可能为 0（本地开发）
- ✅ "查看章节"按钮能跳转

**排行榜页面（`/rankings`）**：
- ✅ 页面正常加载
- ✅ 显示模拟数据或空状态
- ✅ "查看章节"按钮能跳转

---

## 🔍 已知问题和解决方案

### 问题：控制台出现 Redis 错误日志

**现象**：
```
Redis SCAN failed for pattern verse:*: Error: Redis credentials not configured
```

**是否正常**：✅ 是的，这是预期行为

**原因**：本地开发环境没有配置 Redis

**解决**：这些错误不影响功能，所有 API 都有降级逻辑

---

### 问题：Top 7 收藏数为 0

**现象**：本地开发时 Top 7 显示"0 人收藏"

**是否正常**：✅ 是的

**原因**：本地没有 Redis，使用 Mock 数据

**解决**：部署到 Vercel 后会显示真实数据

---

## 📊 成本监控

部署后需要监控的指标：

1. **Upstash Redis 使用量**：
   - 预期：~360K 请求/月
   - 限额：500K 请求/月
   - 使用率：72%

2. **API 端点请求量**：
   - `/api/stats`: ~30K/月
   - `/api/stats/top-verses`: ~30K/月
   - `/api/stats/increment`: ~300K/月
   - `/api/rankings`: ~720/月（ISR缓存）

3. **错误率**：
   - 所有 API 应该 < 1% 错误率
   - 限流触发应该记录日志

---

## ✅ 验收标准

- [ ] 用户统计不再显示 0（生产环境）
- [ ] Top 7 显示经文内容（小字）
- [ ] "查看章节"按钮能正常跳转
- [ ] 总排行榜页面正常显示
- [ ] 本地开发所有功能正常（无需 Redis）
- [ ] 没有控制台错误（除了预期的 Redis 连接错误）
- [ ] 构建成功，没有警告
- [ ] Vercel 部署成功

---

## 🐛 如果遇到问题

### Top 7 仍然不显示经文内容
- 检查 `/api/stats/top-verses` 返回的数据是否包含 `text` 字段
- 查看浏览器控制台是否有错误

### "查看章节"按钮不跳转
- 打开浏览器控制台（F12）
- 点击按钮，查看日志输出
- 如果没有日志，说明点击事件没有触发
- 如果有日志但不跳转，检查 URL 参数处理逻辑

### 用户统计仍然显示 0
- 清除浏览器 localStorage（`user-tracked` 可能已设置）
- 刷新页面
- 如果还是 0，检查 Upstash Redis Dashboard 中的 `total_users` key

---

祝测试顺利！🚀

